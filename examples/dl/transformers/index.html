<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Tiago Almeida (tiagomeloalmeida@ua.pt)" /><link rel="canonical" href="https://ieeta-pt.github.io/HPC-guides/examples/dl/transformers/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Transformers example - Pleiades - IEETA cluster</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Transformers example";
        var mkdocs_page_input_path = "examples/dl/transformers.md";
        var mkdocs_page_url = "/HPC-guides/examples/dl/transformers/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Pleiades - IEETA cluster
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../how_to_access/">How to Access</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../quick_start/">Quick Start</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Detailed Material</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../detail_material/nodes/">Cluster Nodes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../detail_material/software_packages/">Software packages</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../detail_material/job_management/">Job management</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../detail_material/account_management/">Account management</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Deep Learning/CUDA (GPU) Examples</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Transformers example</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#0-git-clone-the-guides-repo-with-the-examples">0. Git clone the guides repo with the examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#1-preprare-the-environment">1. Preprare the environment</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-submit-the-job">2. Submit the job</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="" href="../cuda.md">Cuda example</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mnist/">MNIST example</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Scientific Computing (CPU) Examples</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../sc/dna/">DNA sequencing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sc/r/">R</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Pleiades - IEETA cluster</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Deep Learning/CUDA (GPU) Examples</li>
      <li class="breadcrumb-item active">Transformers example</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="transformers-example">Transformers example</h1>
<p>This example demonstrates how to execute a standard deep learning training pipeline using the transformers library on one of the GPU nodes in the cluster. It is assumed that you already have access and know how to log in.</p>
<h2 id="0-git-clone-the-guides-repo-with-the-examples">0. Git clone the guides repo with the examples</h2>
<p>To facilitate the demonstration, we have prepared the necessary code and scripts in a repository. Your task is to run the code and then delve into it to understand the details more thoroughly.</p>
<pre><code class="language-bash">$ git clone https://github.com/ieeta-pt/HPC-guides.git
$ cd HPC-guides/examples/transformers
</code></pre>
<h2 id="1-preprare-the-environment">1. Preprare the environment</h2>
<p>The first step is to prepare the development environment. This involves loading Python, creating a virtual environment, and installing the dependencies.</p>
<pre><code class="language-bash">$ module load python
$ python -m venv virtual-venv
$ source virtual-venv/bin/activate
(virtual-venv)$ pip install --upgrade pip
(virtual-venv)$ pip install transformers accelerate evaluate datasets scikit-learn
</code></pre>
<h2 id="2-submit-the-job">2. Submit the job</h2>
<p>The hf_classification_trainer.py file contains the essential code needed to train a BERT base model for a classification task using the Yelp dataset. hf_trainer.sh is the launch script that includes SBATCH directives for acquiring resources. Specifically, we are requesting one A6000 GPU (--gres=gpu:nvidia-rtx-a6000:1).</p>
<pre><code class="language-bash">(virtual-venv)$ sbatch hf_trainer.sh
Submitted batch job 95
</code></pre>
<p>After submitting the job, you can check its status in the queue by running squeue:</p>
<pre><code class="language-bash">$ squeue
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
                94       gpu hf_train tiagoalm  R       0:02      1 dl-srv-03
</code></pre>
<p>Here you can see that your job (94) is running (ST = R) and has been allocated to the node dl-srv-03, which contains the A6000 GPU.</p>
<p>To monitor the progress of your training, inspect the output file specified in the launch script:</p>
<pre><code class="language-bash">$ cat hf_trainer-94.out 
Job Information for Job ID: 94 from tiagoalmeida
------------ ------------
Account: students
CPUs per Node: 4
GPU: NVIDIA RTX A6000
Partition: gpu
QOS: normal
Start Time: 2024-07-05 15:12:29 UTC
Running On Node: dl-srv-03
------------ ------------
/var/lib/slurm-llnl/slurmd/job00094/slurm_script: line 9: virtual-venv/bin/activate: No such file or directory
User can use the local tmp dir /tmp/slurm-tiagoalmeida-94
Some weights of BertForSequenceClassification were not initialized from the model checkpoint at bert-base-cased and are newly initialized: ['classifier.bias', 'classifier.weight']
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
amout of GPU memory 51033931776
BATCH SIZE 60
 33%|███▎      | 17/51 [00:26&lt;00:34,  1.01s/i{'eval_loss': 1.6087651252746582, 'eval_accuracy': 0.257, 'eval_runtime': 6.7322, 'eval_samples_per_second': 148.539, 'eval_steps_per_second': 1.337, 'epoch': 1.0}
 43%|████▎     | 22/51 [00:51&lt;01:27,  3.02s/it]
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../../detail_material/account_management/" class="btn btn-neutral float-left" title="Account management"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../mnist/" class="btn btn-neutral float-right" title="MNIST example">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright 2024, Pelouro de Infraestrutura - IEETA UA.</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../../../detail_material/account_management/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../mnist/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
